# MoveSmith

A Move source code level fuzzer.

# Usage

Make sure you have all the necessary [dependencies](#dependencies).

## Fuzzing

To start fuzzing, run
```bash
cargo fuzz run <fuzz_target>
```

All fuzz targets live in `fuzz/fuzz_targets`.

If some unwanted crash stopped the fuzzer and you want to ignore it, use:
```bash
cargo fuzz run <fuzz_target> -- -fork=1 -ignore_crashes=1
```

All crash triggering inputs are stored in `fuzz/artifacts/<fuzz_target>`.  However, the inputs are raw bytes. To convert raw bytes to Move, you can use:
```bash
cargo run --bin raw2move < fuzz/artifacts/<fuzz_target>/<input_file>
```

## Static generator

Instead of directly running the fuzzing session, you can also use the static generator with a fixed seed to generate a number of Move files/packages. This could be helpful to debug the fuzzer or to use the generated files for other purposes.

The generator can be used by `cargo run --bin generator -- <Options>` and available options are:

```
Options:
  -o, --output-dir <OUTPUT_DIR>  The output directory to store the generated Move files
  -s, --seed <SEED>              An optional number as seed, the default should be 0 [default: 0]
  -n, --num-files <NUM_FILES>    An optional number as the number of files to generate, the default should be 100 [default: 100]
  -p, --package                  A boolean flag to create a package, default to false
```
## Coverage

After running a fuzzing session, the coverage of all stored corpus can be generated by:
```bash
./scripts/coverage.sh gen <fuzz_target>
```

This will create an HTML report at `coverage/<fuzz_target>/index.html`.

# Dependencies

## cargo-fuzz

[cargo-fuzz][cargo-fuzz] provides many handy commands for running fuzzing. Install with:
```bash
cargo install cargo-fuzz
```

## Nightly Toolchain

The nightly rust toolchain is required for instrumenting the code. Install with:
```bash
rustup install nightly
```

To overwrite the top-level `rust-toolchain.toml`, use:
```bash
rustup override set nightly
```

## [Optional] Coverage

To generate human-readable coverage reports, we need `llvm` coverage tools.
They can be installed with:
```bash
rustup component add --toolchain nightly llvm-tools-preview
```

# Code Structure

```
.
├── Cargo.toml
├── README.md
├── fuzz
│   ├── Cargo.toml
│   ├── artifacts                 # The inputs that trigger crashes (created after a fuzzing session starts)
│   ├── corpus                    # The corpus of inputs for all fuzz targets (created after a fuzzing session starts)
│   ├── coverage                  # Stores the aggregated raw coverage files (created after collecting coverage)
│   └── fuzz_targets              # Entry points of different fuzz harness
|       └── module_only.rs        # Basic fuzzer that only generates a module and tries to compile it
├── scripts
│   └── coverage.sh               # Collect coverage and generate human-readable reports.
├── src
│   ├── ast.rs                    # The AST for the Move language by the fuzzer
│   ├── cli
│   │   ├── generator.rs          # The static generator for debugging
│   │   └── raw2move.rs           # Converts raw bytes from stdin to a Move program
│   ├── codegen.rs                # Converts the AST to textual Move code
│   ├── config.rs                 # Fuzzer configurations
│   ├── lib.rs
│   ├── move_smith.rs             # The core generation logic
│   └── utils.rs
└── tests
    └── integration_test.rs
```


[cargo-fuzz]: https://github.com/rust-fuzz/cargo-fuzz
